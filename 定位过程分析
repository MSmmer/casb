

#定位过程分析


#0x01、关键现象

```
1、多个域名中只有一个老域名出现卡顿

2、高峰期容易卡顿

3、pdk7004承载主要游戏业务，探测端口响应较慢




```

#0x02排查过程


##华为侧
###界面配置
```
1、梳理用户配置的规则

2、确认后台规则以加载生效

3、确认域名解析是否正常

4、测试源站域名、IP、端口

5、测试高防IP、端口

6、80端口开启waf,8101使用的tcp转发
```
###线路、IDC机房

```
1、是否是小运营商流量

2、运营商安全策略，可能会拦截

3、IDC机房安全策略

```

###时延

```
1、高峰期有问题时,测试线路电信、移动、联通时延

2、测试线路电信、移动、联通时延

3、测试高防IP各线路时延
```

###流量拦截

```
1、DDOS防护策略

2、交换机

3、转发规则

4、waf

```

###回源IP

```
1、回源IP加入白名单
```



##阿里侧
###ECS本地防护

```
1、安琦士配置

2、防火墙配置

3、本地清洗

4、与阿里客服沟通

5、内部搭建阿里云测试环境
```
###ECS

```
1、ECS处理能力

2、出问题时服务器状态

3、主机socket及ulimit限制

4、帐号服务器和游戏服务器限制连接数

5、低峰期、低峰期业务抓包对比

6、客户端与服务端ACK状态检测机制

8、游戏业务架构和数据流程

9、域名、端口、源站交互关系图

10、windows防火墙设置及linux iptables规则

11、系统关键进程状态查看tomcat、httpd、mysql、游戏服

12、登录服、工会服、游戏服异常日志分析

```

##目前进展
```
修改单IP参数后，当前两天未接到用户反馈
```

##建议

```
1、根据实际情况修改以下参数，设置太小可能会导致丢包
MaxConnOfIPaddr      //单IP最大链接数
MaxClientMsgCount    //同链接每秒不能超过15个  
ClientTimeOutTime    //链接后10s未进行登陆断开链接

2、优化客户端与服务端心跳机制
目前心跳机制在代码中写死，无法修改心跳时间，在网络抖动的情况下容易出现断线重连的异常日志。

3、tomcat异常重启，建议排查重启原因

4、内存占有长期超过%85，建议扩容处理

5、tomcat对http头大小设置过小，容易引发404错误。建议修改maxHttpHeaderSize参数

```















